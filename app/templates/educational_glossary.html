{% extends "base.html" %}

{% block title %}Glossário Técnico · Termos Termodinâmicos{% endblock %}

{% block content %}

<div class="page-header">
    <div class="page-header-left">
        <div class="page-title">
            <i class="bi bi-journal-text"></i>
            Glossário Técnico
        </div>
        <div class="page-subtitle">
            Definições completas de termos termodinâmicos
        </div>
    </div>
    <div>
        <button class="btn-sim btn-sim-ghost" onclick="window.location.href='{{ url_for('educational.index') }}'">
            <i class="bi bi-arrow-left"></i> Voltar
        </button>
    </div>
</div>

<!-- Barra de Busca e Filtros -->
<div class="panel mb-3">
    <div class="glossary-controls">
        <div class="search-box-glossary">
            <i class="bi bi-search"></i>
            <input type="text" 
                   id="glossarySearch" 
                   placeholder="Buscar termos, definições, fórmulas..."
                   class="search-input-glossary">
            <button class="btn-clear" id="clearSearch" style="display: none;">
                <i class="bi bi-x-circle-fill"></i>
            </button>
        </div>
        
        <div class="category-filters">
            <button class="category-btn active" data-category="all">
                <i class="bi bi-grid-3x3-gap"></i> Todos
            </button>
            <button class="category-btn" data-category="Propriedades Termodinâmicas">
                <i class="bi bi-thermometer-half"></i> Propriedades
            </button>
            <button class="category-btn" data-category="Modelos Termodinâmicos">
                <i class="bi bi-cpu"></i> Modelos
            </button>
            <button class="category-btn" data-category="Fenômenos de Fase">
                <i class="bi bi-droplet-half"></i> Fenômenos
            </button>
            <button class="category-btn" data-category="Equilíbrio Líquido-Líquido">
                <i class="bi bi-water"></i> ELL
            </button>
            <button class="category-btn" data-category="Equilíbrio Sólido-Líquido">
                <i class="bi bi-snow2"></i> ESL
            </button>
            <button class="category-btn" data-category="Cálculos de Equilíbrio">
                <i class="bi bi-calculator"></i> Cálculos
            </button>
        </div>
    </div>

    <div class="search-stats">
        <span id="resultsCount">Mostrando todos os termos</span>
    </div>
</div>

<!-- Lista de Termos do Glossário -->
<div id="glossaryTermsList" class="glossary-list">
    <!-- Os termos serão carregados aqui via JavaScript -->
</div>

<!-- Template para termo do glossário (hidden) -->
<template id="termCardTemplate">
    <div class="term-card" data-term-key="" data-category="">
        <div class="term-header">
            <div class="term-main">
                <h4 class="term-name"></h4>
                <span class="term-symbol"></span>
            </div>
            <div class="term-category-badge"></div>
        </div>

        <div class="term-definition"></div>

        <div class="term-formula-section">
            <div class="formula-label">
                <i class="bi bi-calculator"></i> Formulação:
            </div>
            <div class="term-formula"></div>
        </div>

        <div class="term-explanation"></div>

        <div class="term-applications">
            <strong><i class="bi bi-star"></i> Aplicações:</strong>
            <ul class="applications-list"></ul>
        </div>

        <div class="term-footer">
            <div class="term-reference">
                <i class="bi bi-book"></i> <span class="reference-text"></span>
            </div>
            <div class="term-related">
                <i class="bi bi-link-45deg"></i>
                <span class="related-terms-list"></span>
            </div>
        </div>

        <button class="btn-expand" onclick="toggleTermExpansion(this)">
            <i class="bi bi-chevron-down"></i>
            <span>Ver mais detalhes</span>
        </button>
    </div>
</template>

<!-- Estatísticas do Glossário -->
<div class="panel mt-4">
    <div class="glossary-stats">
        <div class="stat-item">
            <div class="stat-number" id="totalTerms">0</div>
            <div class="stat-label">Termos Totais</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="categoriesCount">6</div>
            <div class="stat-label">Categorias</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">100%</div>
            <div class="stat-label">Com Fórmulas</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">15+</div>
            <div class="stat-label">Referências</div>
        </div>
    </div>
</div>

<!-- Índice Alfabético -->
<div class="panel mt-3">
    <h5 class="mb-3"><i class="bi bi-list-ol"></i> Índice Alfabético</h5>
    <div class="alphabet-index" id="alphabetIndex">
        <!-- Será preenchido via JavaScript -->
    </div>
</div>

<style>
/* Estilos do glossário */
.glossary-controls {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.search-box-glossary {
    position: relative;
    display: flex;
    align-items: center;
    background: rgba(15, 23, 42, 0.6);
    border: 1px solid rgba(148, 163, 184, 0.5);
    border-radius: 10px;
    padding: 0.8rem 1rem;
    transition: all 0.2s ease;
}

.search-box-glossary:focus-within {
    border-color: #38bdf8;
    box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.2);
}

.search-box-glossary i {
    color: var(--text-soft);
    margin-right: 0.7rem;
    font-size: 1.1rem;
}

.search-input-glossary {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    color: var(--text-main);
    font-size: 0.95rem;
}

.search-input-glossary::placeholder {
    color: var(--text-soft);
}

.btn-clear {
    background: transparent;
    border: none;
    color: var(--text-soft);
    cursor: pointer;
    padding: 0.3rem;
    display: flex;
    align-items: center;
    font-size: 1.2rem;
    transition: color 0.2s;
}

.btn-clear:hover {
    color: var(--text-main);
}

.category-filters {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.category-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.5rem 1rem;
    background: rgba(15, 23, 42, 0.6);
    border: 1px solid rgba(148, 163, 184, 0.3);
    border-radius: 20px;
    color: var(--text-muted);
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.category-btn:hover,
.category-btn.active {
    background: rgba(56, 189, 248, 0.15);
    border-color: rgba(56, 189, 248, 0.7);
    color: var(--text-strong);
}

.search-stats {
    margin-top: 0.8rem;
    padding-top: 0.8rem;
    border-top: 1px solid rgba(148, 163, 184, 0.2);
    font-size: 0.88rem;
    color: var(--text-soft);
}

.glossary-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.term-card {
    background: var(--bg-card);
    border: 1px solid rgba(148, 163, 184, 0.3);
    border-radius: 12px;
    padding: 1.3rem;
    transition: all 0.2s ease;
}

.term-card:hover {
    border-color: rgba(56, 189, 248, 0.5);
    box-shadow: 0 4px 15px rgba(56, 189, 248, 0.1);
}

.term-card.expanded {
    border-color: rgba(56, 189, 248, 0.7);
}

.term-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.8rem;
}

.term-main {
    display: flex;
    align-items: baseline;
    gap: 0.8rem;
}

.term-name {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--text-strong);
    margin: 0;
}

.term-symbol {
    font-family: 'Courier New', monospace;
    font-size: 0.95rem;
    color: #38bdf8;
    background: rgba(56, 189, 248, 0.1);
    padding: 0.2rem 0.6rem;
    border-radius: 4px;
}

.term-category-badge {
    background: rgba(139, 92, 246, 0.15);
    color: #c4b5fd;
    padding: 0.3rem 0.8rem;
    border-radius: 15px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.term-definition {
    font-size: 0.95rem;
    color: var(--text-main);
    line-height: 1.6;
    margin-bottom: 1rem;
    padding: 0.8rem;
    background: rgba(56, 189, 248, 0.05);
    border-left: 3px solid #38bdf8;
    border-radius: 4px;
}

.term-formula-section {
    background: rgba(15, 23, 42, 0.6);
    border: 1px solid rgba(139, 92, 246, 0.3);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.formula-label {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-soft);
    margin-bottom: 0.6rem;
    display: flex;
    align-items: center;
    gap: 0.4rem;
}

.term-formula {
    background: rgba(0, 0, 0, 0.4);
    padding: 0.8rem;
    border-radius: 6px;
    font-family: 'Courier New', monospace;
    color: #e0f2fe;
    font-size: 0.95rem;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.term-explanation {
    font-size: 0.9rem;
    color: var(--text-muted);
    line-height: 1.7;
    margin-bottom: 1rem;
}

.term-applications {
    background: rgba(34, 197, 94, 0.08);
    border-left: 3px solid #22c55e;
    padding: 0.8rem 1rem;
    border-radius: 4px;
    margin-bottom: 1rem;
    font-size: 0.88rem;
}

.term-applications strong {
    color: var(--text-strong);
    display: flex;
    align-items: center;
    gap: 0.4rem;
    margin-bottom: 0.5rem;
}

.applications-list {
    list-style: none;
    padding-left: 1.5rem;
    margin: 0;
}

.applications-list li {
    color: var(--text-muted);
    margin-bottom: 0.3rem;
    position: relative;
}

.applications-list li::before {
    content: "→";
    position: absolute;
    left: -1.2rem;
    color: #22c55e;
}

.term-footer {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
    padding-top: 0.8rem;
    border-top: 1px solid rgba(148, 163, 184, 0.2);
    font-size: 0.82rem;
    color: var(--text-soft);
    margin-bottom: 0.8rem;
}

.term-reference,
.term-related {
    display: flex;
    align-items: flex-start;
    gap: 0.4rem;
}

.term-reference i,
.term-related i {
    margin-top: 0.1rem;
    flex-shrink: 0;
}

.related-terms-list {
    display: flex;
    gap: 0.4rem;
    flex-wrap: wrap;
}

.related-term-tag {
    background: rgba(56, 189, 248, 0.15);
    color: #7dd3fc;
    padding: 0.2rem 0.6rem;
    border-radius: 10px;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s;
}

.related-term-tag:hover {
    background: rgba(56, 189, 248, 0.25);
    color: #38bdf8;
}

.btn-expand {
    width: 100%;
    background: rgba(15, 23, 42, 0.5);
    border: 1px solid rgba(148, 163, 184, 0.3);
    border-radius: 8px;
    padding: 0.6rem;
    color: var(--text-muted);
    font-size: 0.85rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.4rem;
    transition: all 0.2s;
}

.btn-expand:hover {
    background: rgba(15, 23, 42, 0.8);
    border-color: rgba(148, 163, 184, 0.5);
    color: var(--text-main);
}

.btn-expand i {
    transition: transform 0.2s;
}

.term-card.expanded .btn-expand i {
    transform: rotate(180deg);
}

.term-card .term-explanation,
.term-card .term-applications,
.term-card .term-footer {
    display: none;
}

.term-card.expanded .term-explanation,
.term-card.expanded .term-applications,
.term-card.expanded .term-footer {
    display: block;
}

.term-card.expanded .term-related {
    display: flex;
}

.glossary-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1.5rem;
}

.stat-item {
    text-align: center;
    padding: 1rem;
    background: rgba(15, 23, 42, 0.4);
    border: 1px solid rgba(148, 163, 184, 0.3);
    border-radius: 10px;
}

.stat-number {
    font-size: 2rem;
    font-weight: 700;
    color: #38bdf8;
    margin-bottom: 0.3rem;
}

.stat-label {
    font-size: 0.85rem;
    color: var(--text-soft);
}

.alphabet-index {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.alphabet-letter {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(15, 23, 42, 0.6);
    border: 1px solid rgba(148, 163, 184, 0.3);
    border-radius: 8px;
    color: var(--text-muted);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.alphabet-letter:hover,
.alphabet-letter.active {
    background: rgba(56, 189, 248, 0.15);
    border-color: rgba(56, 189, 248, 0.7);
    color: var(--text-strong);
}

.alphabet-letter.disabled {
    opacity: 0.3;
    cursor: not-allowed;
}

.alphabet-letter.disabled:hover {
    background: rgba(15, 23, 42, 0.6);
    border-color: rgba(148, 163, 184, 0.3);
    color: var(--text-muted);
}

@media (max-width: 768px) {
    .term-footer {
        flex-direction: column;
    }
    
    .category-filters {
        justify-content: center;
    }
}
</style>

{% endblock %}

{% block extra_js %}
<script>
// ✅ INJETAR DADOS DO GLOSSÁRIO DO BACKEND PARA O JAVASCRIPT
window.educationalJS = {
    glossaryTerms: {{ glossary_terms | tojson | safe }}
};
</script>

<script>
// Carregar termos do glossário
const glossaryTerms = window.educationalJS?.glossaryTerms || {};

document.addEventListener('DOMContentLoaded', function() {
    loadGlossaryTerms();
    setupSearch();
    setupFilters();
    buildAlphabetIndex();
    updateStats();
});

function loadGlossaryTerms(filter = 'all', searchQuery = '') {
    const container = document.getElementById('glossaryTermsList');
    const template = document.getElementById('termCardTemplate');
    container.innerHTML = '';
    
    let terms = Object.entries(glossaryTerms);
    let filteredCount = 0;
    
    // Ordenar alfabeticamente
    terms.sort((a, b) => a[1].term.localeCompare(b[1].term));
    
    terms.forEach(([key, data]) => {
        // Filtrar por categoria
        if (filter !== 'all' && data.category !== filter) {
            return;
        }
        
        // Filtrar por busca
        if (searchQuery) {
            const searchLower = searchQuery.toLowerCase();
            const matchTerm = data.term.toLowerCase().includes(searchLower);
            const matchDef = data.definition.toLowerCase().includes(searchLower);
            const matchFormula = data.formula.toLowerCase().includes(searchLower);
            const matchExplanation = data.explanation.toLowerCase().includes(searchLower);
            
            if (!matchTerm && !matchDef && !matchFormula && !matchExplanation) {
                return;
            }
        }
        
        filteredCount++;
        
        // Clonar template
        const clone = template.content.cloneNode(true);
        const card = clone.querySelector('.term-card');
        
        card.dataset.termKey = key;
        card.dataset.category = data.category;
        
        clone.querySelector('.term-name').textContent = data.term;
        clone.querySelector('.term-symbol').textContent = data.symbol || '-';
        clone.querySelector('.term-category-badge').textContent = data.category;
        clone.querySelector('.term-definition').textContent = data.definition;
        clone.querySelector('.term-formula').textContent = data.formula;
        clone.querySelector('.term-explanation').textContent = data.explanation;
        clone.querySelector('.reference-text').textContent = data.reference;
        
        // Aplicações
        const appsList = clone.querySelector('.applications-list');
        data.applications.forEach(app => {
            const li = document.createElement('li');
            li.textContent = app;
            appsList.appendChild(li);
        });
        
        // Termos relacionados
        const relatedContainer = clone.querySelector('.related-terms-list');
        data.related_terms.forEach(relKey => {
            const relatedTerm = glossaryTerms[relKey];
            if (relatedTerm) {
                const tag = document.createElement('span');
                tag.className = 'related-term-tag';
                tag.textContent = relatedTerm.term;
                tag.onclick = () => scrollToTerm(relKey);
                relatedContainer.appendChild(tag);
            }
        });
        
        container.appendChild(clone);
    });
    
    // Atualizar contador
    const statsEl = document.getElementById('resultsCount');
    if (searchQuery) {
        statsEl.textContent = `${filteredCount} termo(s) encontrado(s) para "${searchQuery}"`;
    } else if (filter !== 'all') {
        statsEl.textContent = `${filteredCount} termo(s) na categoria selecionada`;
    } else {
        statsEl.textContent = `Mostrando todos os ${filteredCount} termos`;
    }
}

function setupSearch() {
    const searchInput = document.getElementById('glossarySearch');
    const clearBtn = document.getElementById('clearSearch');
    
    searchInput.addEventListener('input', function() {
        const query = this.value.trim();
        const activeFilter = document.querySelector('.category-btn.active').dataset.category;
        
        loadGlossaryTerms(activeFilter, query);
        
        clearBtn.style.display = query ? 'flex' : 'none';
    });
    
    clearBtn.addEventListener('click', function() {
        searchInput.value = '';
        searchInput.dispatchEvent(new Event('input'));
        searchInput.focus();
    });
}

function setupFilters() {
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            const category = this.dataset.category;
            const searchQuery = document.getElementById('glossarySearch').value.trim();
            
            loadGlossaryTerms(category, searchQuery);
        });
    });
}

function toggleTermExpansion(btn) {
    const card = btn.closest('.term-card');
    card.classList.toggle('expanded');
    
    const span = btn.querySelector('span');
    if (card.classList.contains('expanded')) {
        span.textContent = 'Ver menos';
    } else {
        span.textContent = 'Ver mais detalhes';
    }
}

function scrollToTerm(termKey) {
    const card = document.querySelector(`[data-term-key="${termKey}"]`);
    if (card) {
        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
        card.classList.add('expanded');
        
        // Highlight temporário
        card.style.background = 'rgba(56, 189, 248, 0.1)';
        setTimeout(() => {
            card.style.background = '';
        }, 2000);
    }
}

function buildAlphabetIndex() {
    const container = document.getElementById('alphabetIndex');
    const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
    
    // Verificar quais letras têm termos
    const termsFirstLetters = new Set();
    Object.values(glossaryTerms).forEach(term => {
        termsFirstLetters.add(term.term[0].toUpperCase());
    });
    
    alphabet.forEach(letter => {
        const btn = document.createElement('div');
        btn.className = 'alphabet-letter';
        btn.textContent = letter;
        
        if (termsFirstLetters.has(letter)) {
            btn.onclick = () => filterByLetter(letter);
        } else {
            btn.classList.add('disabled');
        }
        
        container.appendChild(btn);
    });
}

function filterByLetter(letter) {
    const searchInput = document.getElementById('glossarySearch');
    searchInput.value = '';
    
    const cards = document.querySelectorAll('.term-card');
    cards.forEach(card => {
        const termName = card.querySelector('.term-name').textContent;
        if (termName[0].toUpperCase() === letter) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
    
    // Atualizar active state
    document.querySelectorAll('.alphabet-letter').forEach(btn => {
        btn.classList.toggle('active', btn.textContent === letter);
    });
    
    document.getElementById('resultsCount').textContent = 
        `Termos iniciados com "${letter}"`;
}

function updateStats() {
    const totalTerms = Object.keys(glossaryTerms).length;
    document.getElementById('totalTerms').textContent = totalTerms;
}
</script>
{% endblock %}
